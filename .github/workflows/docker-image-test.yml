name: Test docker containers

on: [push, pull_request]

jobs:
  build:
    name: Build
    # We want a newer version of qemu: https://bugs.launchpad.net/ubuntu/+source/qemu/+bug/1815100
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        platform: [linux/amd64, linux/arm64/v8, linux/arm/v7]
        dockerfile: [Dockerfile, alpine/Dockerfile]
    steps:
      - name: Set env
        run: echo "mount_dir=$(mktemp -d)" >> $GITHUB_ENV

      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
        with:
          install: true

      - name: Build Docker image
        run: docker build --platform ${{ matrix.platform }} -t thelounge -f ${{ matrix.dockerfile }} .

      - name: Start Docker container
        run: docker run --platform ${{ matrix.platform }} --user "$UID" -v "${mount_dir}:/var/opt/thelounge" -d -p 9001:9000 --name thelounge thelounge

      - name: Check TheLounge version
        run: docker exec thelounge thelounge --version | grep --color=never -E "^v[0-9]\.[0-9]\.[0-9]" | cut -c 2- | grep -f /dev/stdin ${{ matrix.dockerfile }}

      - name: Wait for server to (hopefully) start
        run: sleep 3

      - name: Check HTML output
        run: curl -sL localhost:9001 | grep "<title>The Lounge</title>"

      - name: Check for config.js to be created in the mounted host system directory
        run: stat "${mount_dir}/config.js"

      - name: Logs
        run: docker logs thelounge
